
---
title:  "`r ifelse(input$country1=='Select all',print('Summary report for COVID-19 in the World'),paste('Summary report for COVID-19 in',input$country1,ifelse(input$province1 != 'Select all', paste(',',input$province1) ,'')))`"

author: | 
  | This report generated by COVID-19 Reporter dashboard created by Dr.[Mahdi Hadi](https://www.tums.ac.ir/faculties/m-hadi), Ph.D. of Environmental Health Engineering, Assisstant Professor at the Institute for Environmental Research (IER), Center for Water Quality Research (CWQR), Tehran University of Medical Sciences.
  Email:m.hadi1981@gmail.com ; m-hadi@sina.tums.ac.ir
date:  
output: html_document


---

```{r,echo=FALSE }
# take mean with confience interval from columns
MeanFunc<-function(x) round(mean(x,na.rm = TRUE),digits=6 )
SEFunc<-function(x) round(qt(0.975,df=sum(!is.na(x))-1)*sd(x,na.rm = TRUE)/sqrt(sum(!is.na(x)) ),digits=5 )
SDFunc<-function(x) round(sd(x,na.rm = TRUE),digits=5 )
LeftFunc<-function(x)  round(mean(x,na.rm = TRUE)-SEFunc(x),digits=5) 
RightFunc<-function(x) round(mean(x,na.rm = TRUE)+SEFunc(x),digits=5)  
MaxFunc<-function(x) round(max(x,na.rm = TRUE) ,digits=5)  
MinFunc<-function(x) round(min(x,na.rm = TRUE) ,digits=5) 

multi.fun <- function(x) {
  c(Mean = MeanFunc(x), SE = SEFunc(x), SD = SDFunc(x), Left=LeftFunc(x),Right=RightFunc(x),Max=MaxFunc(x),Min=MinFunc(x))
}

WorldSummary<-apply(LatestDataTable()[,3:8],2, multi.fun)

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r echo=FALSE}
#Determine the output format of the document
outputFormat   = opts_knit$get("rmarkdown.pandoc.to")

#Figure and Table Caption Numbering, for HTML do it manually
capTabNo = 1; capFigNo = 1;

#Function to add the Table Number
capTab = function(x){
  if(outputFormat == 'html'){
    x = paste0("Table ",capTabNo,". ",x)
    capTabNo <<- capTabNo + 1
  }; x
}

#Function to add the Figure Number
capFig = function(x){
  if(outputFormat == 'html'){
    x = paste0("Figure ",capFigNo,". ",x)
    capFigNo <<- capFigNo + 1
  }; x
}
```

## **Introduction**

<font size="4">
Coronavirus disease 2019 (COVID-19) is an infectious disease caused by severe acute respiratory syndrome coronavirus 2 (SARS-CoV-2) [(1)](https://www.who.int/emergencies/diseases/novel-coronavirus-2019/technical-guidance/naming-the-coronavirus-disease-%28covid-2019%29-and-the-virus-that-causes-it). On 31 December 2019, the WHO China Country Office was informed the first cases of Coronavirus disease 2019 (COVID-19) in Wuhan City, Hubei Province of China [(2)](https://www.who.int/docs/default-source/coronaviruse/situation-reports/20200121-sitrep-1-2019-ncov.pdf?sfvrsn=20a99c10_4). 
COVID-19 disease is spreading rapidly throughout the world. The outbreak was declared a public health emergency of international concern on 30 January 2020  [(3)](https://www.who.int/emergencies/diseases/novel-coronavirus-2019/events-as-they-happen).WHO declared the outbreak a global pandemic on March 11, 2020 [(4)](https://www.who.int/dg/speeches/detail/who-director-general-s-opening-remarks-at-the-media-briefing-on-covid-19---11-march-2020). This summarry report includes:

* Source of data 
* Cumulative and new cases for the World
* COVID-19 trend in `r ifelse(input$country1=='Select all',print('the World'),paste(input$country1,ifelse(input$province1 != 'Select all', paste(',',input$province1) ,'')))` 
* COVID-19 death rate in `r ifelse(input$country1=='Select all',print('the World'),paste(input$country1,ifelse(input$province1 != 'Select all', paste(',',input$province1),'')))` 
* Description of SEIR model
* SEIR results for `r ifelse(input$country1=='Select all',print('the World'),paste(input$country1,ifelse(input$province1 != 'Select all', paste(',',input$province1) ,'')))` 

</font>  

## **Source of data**

<font size="4">

All data used in this application is from [Johns Hopkins CSSE](https://systems.jhu.edu/). This summary report was produced after applying several pre-processings on the [time-series raw data](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series) are available in John Hopkins Github repository. Following table includes all data for **`r nrow(WorldSumDiffS)`** countries from **`r min(WorldDataMg$Date)`** to **`r max(WorldDataMg$Date)`**. For countries including   **`r DFCountry`**, the data are available at provincial level.    

<font>


## **Cumulative and new cases for the World**

<font size="4">
Globally, as of **`r  max(WorldSumDiffS$Date)  `**, there have been <span style="color: orange;">**`r sprintf("%.0f",  sum(WorldSumDiffS$Confirmed) )`**</span>  confirmed cases of COVID-19, including <span style="color: red;">**`r sprintf("%.0f",  sum(WorldSumDiffS$Deaths))`**</span> deaths, reported officialy by **`r nrow(WorldSumDiffS)`** countries. 
At **`r max(WorldSumDiffS$Date)`**, there have been <span style="color: orange;">**`r sprintf("%.0f",  sum(WorldSumDiffS$New.Confirmed))`**</span> new confirmed cases including <span style="color: red;">**`r sprintf("%.0f",  sum(WorldSumDiffS$New.Deaths))`**</span> new deaths.
Following table summarizes the statistics for cumulative and new cases of COVID-19. As presented, the mean for confirmed, recovered
and deaths cases are **`r paste(sprintf("%.0f",WorldSummary[1,1]),"±",sprintf("%.0f",WorldSummary[2,1]))`**, **`r paste(sprintf("%.0f",WorldSummary[1,2]),"±",sprintf("%.0f",WorldSummary[2,2]))`** and **`r paste(sprintf("%.0f",WorldSummary[1,3]),"±",sprintf("%.0f",WorldSummary[2,3]))`**, respectively.
<font>


```{r,echo=F,  out.width = "30%" }
library(knitr)
library(kableExtra)
library(plyr)
library(dplyr)
kable(WorldSummary, longtable = TRUE,  caption = " Table 1: Summary statistics for global cumulative and new cases of COVID-19") %>% 
  kable_styling(full_width = F)  
 
```

## **COVID-19 trend in `r ifelse(input$country1=='Select all',print('the World'),paste(input$country1,ifelse(input$province1 != 'Select all',  paste(',',input$province1) ,'')))`**
The trends for confirmed, recovered and deaths cases for `r ifelse(input$country1=='Select all',print('the World'),paste(input$country1,ifelse(input$province1 != 'Select all', paste(',',input$province1) ,'')))` are presented in following figure. 

```{r  , echo=FALSE , fig.align="center", out.width = "30%", fig.cap = capFig("Trend of confirmed, recovered and deaths cases")}
    PlotCum <- reactive({
      if(input$country1=="Select all" & input$province1=="Select all"){
        aggregate(value~ variable+Date,WorldSum,FUN = "sum" )
      }else if (input$country1!="Select all" & input$province1=="Select all") {
        DF<-WorldSum[which(WorldSum$Country.Region==input$country1), ] 
        aggregate(value~ variable+Date+Country.Region,DF,FUN = "sum" ) 
      }else{
        DF<-WorldSum[which(WorldSum$Country.Region==input$country1 & WorldSum$Province.State==input$province1), ] 
        aggregate(value~ variable+Date+Province.State,DF,FUN = "sum" ) 
        
      }
    }) 
 PlotCum()%>%
 dplyr::group_by(variable)%>% 
          echarts4r::e_charts(Date) %>% 
          echarts4r::e_line(value) %>% 
          # echarts4r::e_line(model, name = "Fit", lineStyle = ls) %>% 
          echarts4r::e_tooltip(trigger = "axis")%>% 
          echarts4r::e_color(c("brown", "green","red") )%>% #,background = "gray"
          e_grid(containLabel=T,left = "20%",right = "20%")%>%   #show axes title completely
          e_theme("shine") # https://echarts4r.john-coene.com/articles/themes.html

```

## **COVID-19 death rate in `r ifelse(input$country1=='Select all',print('the World'),paste(input$country1,ifelse(input$province1 != 'Select all', paste(',',input$province1) ,'')))`**

The death rate was determined based on [The Lancet article](https://www.thelancet.com/journals/laninf/article/PIIS1473-3099%2820%2930195-X/fulltext) by dividing the number of deaths on a given day by the number of patients with confirmed COVID-19 infection 14 days before.

```{r,echo=FALSE, fig.align="center", out.width = "30%", fig.cap = capFig("Change of death rate by date")}
        
        form <- htmlwidgets::JS("function(value){
    return(value + '%')
  }")
PlotCum() %>% 
            dplyr::group_by(variable) %>% 
            dplyr::ungroup() %>%
            tidyr::pivot_wider(
              id_cols = Date,
              names_from = variable,
              values_from = value
              
            ) %>%
            dplyr::mutate(
              #https://www.thelancet.com/journals/laninf/article/PIIS1473-3099(20)30195-X/fulltext
              #https://www.worldometers.info/coronavirus/coronavirus-death-rate/
              rate = Deaths / (lag(Confirmed,14)),
              rate = round(rate * 100, 3)
            ) %>%  
            mutate(rate=replace(rate, rate>100, 100)) %>%
            echarts4r::e_charts(Date) %>% 
            echarts4r::e_area(rate, name = "Death rate") %>% 
            echarts4r::e_tooltip(trigger = "axis") %>% 
            echarts4r::e_legend(FALSE) %>% 
            echarts4r::e_y_axis(formatter = form) %>% 
            #echarts4r::e_color(background = "gray" )%>%
            #echarts4r::e_visual_map(
            #   rate,
            #  show = FALSE,
            #  inRange = list(
            #    color = deaths_pal
            #  )
            # ) %>% 
            echarts4r::e_mark_point(
              data = list(type = "max"), 
              itemStyle = list(color = "skyblue"),
              label = list(color = "#000"),
              title = "Max"
            ) %>% 
            echarts4r::e_mark_line(
              data = list(type = "average"),
              itemStyle = list(color = "blue"),
              title = "Average"
            ) %>%
            e_grid(containLabel=T,right = "20%",left = "20%")%>%   #show axes title completely
            e_theme("shine") # https://echarts4r.john-coene.com/articles/themes.html
```

## **Description of SEIR model**
<font size="4">In this dashboard a compartmental epidemiological model, based on the classic SEIR model was used to describe the spread of COVID-19. A nice primer to SEIR model is available on [Wikipedia](https://en.wikipedia.org/wiki/Compartmental_models_in_epidemiology). If no intervention to mitigate social contacts is applied, the SEIR model for the basic condition can be described as follows: </font>

\begin{equation}
\frac{dS_b}{dt}=-\frac{\beta {S_b}{I_b}}{N}
\end{equation}

\begin{equation}
\frac{dE_b}{dt}=\frac{\beta {S_b}{I_b}}{N}-{\sigma {E_b}} \\
\end{equation}

\begin{equation}
\frac{dI_b}{dt}={\sigma {E_b}}-{\gamma {I_b}} \\
\end{equation}

\begin{equation}
\frac{dR_b}{dt}={\gamma {I_b}} \\
\end{equation}



### **Variables of SEIR model at the basic condition**
* $S_b$: Susceptible individuals
* $E_b$: Exposed individuals - infected but not yet infectious or symptomatic
* $I_b$: Infected individuals   
* $R_b$: individuals who have recovered from disease or dead
* $N=S_b+E_b+I_b+R_b$: Total population size (constant)


### **Parameters**
* $\beta$: rate at which infected individuals in class $I$ contact susceptibles and infect them
* $\sigma$: rate of progression from the exposed to infected class
* $\gamma$: rate at which infected individuals in class $I$ recover from disease or become dead


### **Incorporate effect of social distancing**

<font size="4">Social distancing, or physical distancing, is a set of non-pharmaceutical interventions or measures taken to prevent the spread of a contagious disease by maintaining a physical distance between people and reducing the number of times people come into close contact with each other [(Wikipedia)](https://en.wikipedia.org/wiki/Social_distancing).It includes avoiding large gatherings, physical contact, and other efforts to mitigate the spread of infectious disease. According to above model, the term in model that this is going to impacted by incorporatig effect of social distansing is the contact rate, $\beta$.

From the perspective of epidemiology, the basic goal behind social distancing is to decrease the basic reproduction number, $R_0$, which is the average number of secondary infected individuals generated from one primary infected individual in a population where all individuals are equally susceptible to a disease. In a basic model of social distancing,a proportion $f$ of the population engages in social distancing to decrease their interpersonal contacts to a fraction $c$ of their normal contacts.

To introduce social distancing effect into ESIR model, SEIR system of differential equations can be modified as follows:</font>  


\begin{equation}
\frac{dS_i}{dt}=-\frac{\beta(1-(1-{c}^{2}){f})S_iI_i}{N}
\end{equation}

\begin{equation}
\frac{dE_i}{dt}=\frac{\beta(1-(1-{c}^{2}){f}) S_iI_i}{N}-{\sigma E_i} \\
\end{equation}

\begin{equation}
\frac{dI_i}{dt}={\sigma E_i}-{\gamma I_i} \\
\end{equation}

\begin{equation}
\frac{dR_i}{dt}={\gamma I_i} \\
\end{equation}

### **Variables in the SEIR model after intervention**
* $S_i$: Susceptible individuals after social dsitancing
* $E_i$: Exposed individuals - infected but not yet infectious or symptomatic after social dsitancing
* $I_i$: Infected individuals after social dsitancing   
* $R_i$: Individuals who have recovered from disease or dead after social dsitancing
* $N=S_i+E_i+I_i+R_i$: Total population size (constant)


<font size="4">In the modified SEIR model, the values of $S_i$, $E_i$, $I_i$ and $R_i$ are directly dependent to $c$ and $f$. In the initial state of the intervention model it is assumed that nothing intervention was applied.In another word, total proportion of the population not engages ($f$=0) in social distancing to decrease their interpersonal contacts to a fraction $c$ of their normal contacts and the initial value for fraction $c$ was assumed to be 1 or 100% ($c$=1). 
Flattening the infection curve relies on mitigation by applying social distancing.Thus to see the effect of social distancing intervention, the value of $f$ and $c$ must be changed, simultaneously. By increasing the $f$ and decreasing $c$, the sharp peak of $I_i$ will be flattened to slow the spread of the epidemic and extend time for healthcare services to deal with demands. 


After intervention with social distancing the effective reproduction number $R_t$ will be given by:</font> 


\begin{equation}
 {R}= (1-(1-c^2){f}){R_0} 
\end{equation}

<font size="4">For example, if 25% ($f$=25%) of the population reduce their social contacts to 50% ($c$=50%) of their normal level, the effective reproduction number will be about 81% of the basic reproduction number ($R_0$).</font>

## **SEIR results for `r ifelse(input$country1=='Select all',print('the World'),paste(input$country1,ifelse(input$province1 != 'Select all', paste(',',input$province1) ,'')))`**


### **Current basic condition**
<font size="4">
The basic reproduction number, $R_0$, is the expected number of new infections from a single infection in a population where all subjects are susceptible. The estimated basic reproduction number is **`r sprintf("%.2f", R_zero)`**. The typical time between contacts and the estimated incubation period are **`r sprintf("%.2f", 1/(Opt()$par[1]*(1-(1-C.^2)*F._Value)))`** and **`r sprintf("%.2f", 1/(Opt()$par[3]))`** days, respectively. The typical time for an infected individual to recover is **`r sprintf("%.2f", 1/(Opt()$par[2]))`** days. At the current condition which represent a **`r sprintf("%.2f", (1-Opt()$par[4])*100)`** % social contacts for **`r sprintf("%.2f", (1-(Opt()$par[5]))*100)`** % of population, it is expected that on **`r as.character(DateMax)`** the basic number of confirmed cases (I.b) will reach its peak number of **`r sprintf("%.0f", Imax)`** cases.

* **Note**: It should be noticed that there are limitations to the analyses performed, including uncertainties around estimates of $R_0$ and and other parameters.


### **Intervention by reducing $c$ and increasing $f$ **
In the intervention model you assumed **`r sprintf("%.2f", ((F._Value)*100))`** % of population reduce their social contacts by **`r sprintf("%.2f", (1-C.)*100 )`**%. With such intervention the individual social contacts will reduce  to **`r sprintf("%.2f", (1-Opt()$par[4])*100-((1-C.)*100))`** % for **`r sprintf("%.2f", (Opt()$par[5])*100+((F._Value)*100))`** % of population. The max number of confirmed cases (I.i) will reach to **`r sprintf("%.0f", ImaxInterv)`** on **`r as.character(DateMaxInterv)`**.`r ifelse(is.na(INextmaxInterv),print("This max value is at the upper bound of the data, and therefore may not be the actual max, increase forecast step to reach the peak value."),print(""))` This intervention gives an effective reproduction number ($R_t$) about **`r sprintf("%.0f", (((1-(1-C.^2)*F._Value)*R_zero)/R_zero)*100)`**% of the basic reproduction number ($R_0$). </font>




```{r,echo=F, results='asis'}

BETA<-Opt()$par[1]*(1-(1-C.^2)*F._Value)
SIGMA<-Opt()$par[3]
GAMA<-Opt()$par[2]
R0<-Opt()$par[1]/Opt()$par[2]
RT<-(1-(1-C.^2)*F._Value)*R_zero
R0R<-sprintf("%.0f", 100-((((1-(1-C.^2)*F._Value)*R_zero)/R_zero)*100))
C.value<-(1-Opt()$par[4])*100-((1-C.)*100)
F.value<- (Opt()$par[5])*100+((F._Value)*100)
Population<-N.
Ib<-sprintf("%.0f", Imax)
Ii<-sprintf("%.0f", ImaxInterv)
Dateb<- as.character(DateMax)
Datei<-as.character(DateMaxInterv)
  

 a <- structure(list( c("$\\beta$", "$\\sigma$", "$\\gamma$", "$R_0$", "$R_t$","$R_r$","$c$","$f$","$N$","$I_b$","$Date_{I_b}$","$I_i$","$Date_{I_i}$"
), Definition = c(
                  "the effective contact rate",
                  "The infection rate of an exposed person",
                  "The recovery rate of an infected person",
                  "The basic reproduction number",
                  "The effective reproduction number",
                  "Reduction of basic reproduction number",
                  "The social contacts",
                  "Population involved in social distancing intervention", 
                  "Population",
                  "The basic number of confirmed cases",
                  "$I_b$ peak date",
                  "Confirmed cases with intervention",
                  "$I_i$ peak date"), Unit = c("$day^{-1}$", 
"$day^{-1}$", "$day^{-1}$", "dimensionless", "dimensionless","%","%","%","People","People","Date","People","Date"),Value = c(BETA, SIGMA, GAMA, R0,RT,R0R,C.value,F.value,Population,Ib,Dateb,Ii,Datei)), .Names = c("Parameter","Definition", "Unit", "Estimated value"), row.names = c(NA, 13L), class = "data.frame")
 

```


```{r,echo=F ,eval=T, out.width = "30%"}
 kable(a, booktabs = TRUE, longtable = TRUE,caption = "Table 2: Estimated values of epidemiological parameters in SEIR model") %>% 
  kable_styling(full_width = F)  
   
```


```{r,echo=FALSE, fig.align="center", out.width = "30%", fig.cap = capFig("SEIR plot")}
 SEIRPLOT() 
```

