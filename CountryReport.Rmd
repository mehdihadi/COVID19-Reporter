
---
title:  "`r ifelse(input$country=='Select all',print('Summary report for COVID19 in the World'),paste('Summary report for COVID-19 in',input$country,ifelse(input$province != 'Select all', paste(',',input$province) ,'')))`"

author: | 
  | This report generated by COVID19 Reporter dashboard created by Dr.[Mahdi Hadi](https://www.tums.ac.ir/faculties/m-hadi), Ph.D. of Environmental Health Engineering, Assisstant Professor at the Institute for Environmental Research (IER), Center for Water Quality Research (CWQR), Tehran University of Medical Sciences,Tehran, Iran.
  Email:m.hadi1981@gmail.com ; m-hadi@sina.tums.ac.ir
date:  
output: html_document
 

---

```{r,echo=FALSE , warning=FALSE}
# take mean with confience interval from columns
MeanFunc<-function(x) round(mean(x,na.rm = TRUE),digits=6 )
SEFunc<-function(x) round(qt(0.975,df=sum(!is.na(x))-1)*sd(x,na.rm = TRUE)/sqrt(sum(!is.na(x)) ),digits=5 )
SDFunc<-function(x) round(sd(x,na.rm = TRUE),digits=5 )
LeftFunc<-function(x)  round(mean(x,na.rm = TRUE)-SEFunc(x),digits=5) 
RightFunc<-function(x) round(mean(x,na.rm = TRUE)+SEFunc(x),digits=5)  
MaxFunc<-function(x) round(max(x,na.rm = TRUE) ,digits=5)  
MinFunc<-function(x) round(min(x,na.rm = TRUE) ,digits=5) 

multi.fun <- function(x) {
  c(Mean = MeanFunc(x), SE = SEFunc(x), SD = SDFunc(x), Left=LeftFunc(x),Right=RightFunc(x),Max=MaxFunc(x),Min=MinFunc(x))
}

WorldSummary<-apply(LatestDataTable()[,3:8],2, multi.fun)
CountrySummary<-apply(CountryDataTable()[,7:9],2, multi.fun)

```

```{r setup, include=FALSE }
knitr::opts_chunk$set(echo = FALSE)
```

```{r echo=FALSE}
#Determine the output format of the document
outputFormat   = opts_knit$get("rmarkdown.pandoc.to")

#Figure and Table Caption Numbering, for HTML do it manually
capTabNo = 1; capFigNo = 1;

#Function to add the Table Number
capTab = function(x){
  if(outputFormat == 'html'){
    x = paste0("Table ",capTabNo,". ",x)
    capTabNo <<- capTabNo + 1
  }; x
}

#Function to add the Figure Number
capFig = function(x){
  if(outputFormat == 'html'){
    x = paste0("Figure ",capFigNo,". ",x)
    capFigNo <<- capFigNo + 1
  }; x
}
```

## **Introduction**

<font size="4">
Coronavirus disease 2019 (COVID-19) is an infectious disease caused by severe acute respiratory syndrome coronavirus 2 (SARS-CoV-2) [(1)](https://www.who.int/emergencies/diseases/novel-coronavirus-2019/technical-guidance/naming-the-coronavirus-disease-%28covid-2019%29-and-the-virus-that-causes-it). On 31 December 2019, the WHO China Country Office was informed the first cases of Coronavirus disease 2019 (COVID-19) in Wuhan City, Hubei Province of China [(2)](https://www.who.int/docs/default-source/coronaviruse/situation-reports/20200121-sitrep-1-2019-ncov.pdf?sfvrsn=20a99c10_4). 
COVID-19 disease is spreading rapidly throughout the world. The outbreak was declared a public health emergency of international concern on 30 January 2020  [(3)](https://www.who.int/emergencies/diseases/novel-coronavirus-2019/events-as-they-happen).WHO declared the outbreak a global pandemic on March 11, 2020 [(4)](https://www.who.int/dg/speeches/detail/who-director-general-s-opening-remarks-at-the-media-briefing-on-covid-19---11-march-2020). This summarry report includes:

* Source of data 
* Cumulative and new cases for the World
* COVID-19 trend in `r ifelse(input$country=='Select all',print('the World'),paste(input$country,ifelse(input$province!= 'Select all', paste(',',input$province) ,'')))` 
* COVID-19 death rate in `r ifelse(input$country=='Select all',print('the World'),paste(input$country,ifelse(input$province!= 'Select all', paste(',',input$province),'')))` 


</font>  

## **Source of data**

<font size="4">

All data used in this application is from [Johns Hopkins CSSE](https://systems.jhu.edu/). This summary report was produced after applying several pre-processings on the [time-series raw data](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series) are available in John Hopkins Github repository. Following table includes all data for **`r nrow(WorldSumDiffS)`** countries from **`r min(WorldDataMg$Date)`** to **`r max(WorldDataMg$Date)`**. For countries including   **`r DFCountry`**, the data are available at provincial level.    

<font>


## **Cumulative and new cases for the World**

<font size="4">
Globally, as of **`r  max(WorldSumDiffS$Date)  `**, there have been <span style="color: orange;">**`r sprintf("%.0f",  sum(WorldSumDiffS$Confirmed) )`**</span>  confirmed cases of COVID-19, including <span style="color: red;">**`r sprintf("%.0f",  sum(WorldSumDiffS$Deaths))`**</span> deaths, reported officialy by **`r nrow(WorldSumDiffS)`** countries. 
At **`r max(WorldSumDiffS$Date)`**, there have been <span style="color: orange;">**`r sprintf("%.0f",  sum(WorldSumDiffS$New.Confirmed))`**</span> new confirmed cases including <span style="color: red;">**`r sprintf("%.0f",  sum(WorldSumDiffS$New.Deaths))`**</span> new deaths.
Following table summarizes the statistics for cumulative and new cases of COVID-19. As presented, the mean for confirmed, recovered
and deaths cases are **`r paste(sprintf("%.0f",WorldSummary[1,1]),"±",sprintf("%.0f",WorldSummary[2,1]))`**, **`r paste(sprintf("%.0f",WorldSummary[1,2]),"±",sprintf("%.0f",WorldSummary[2,2]))`** and **`r paste(sprintf("%.0f",WorldSummary[1,3]),"±",sprintf("%.0f",WorldSummary[2,3]))`**, respectively.
<font>


```{r,echo=F,  out.width = "30%" }
library(knitr)
library(kableExtra)
library(plyr)
library(dplyr)
kable(WorldSummary, longtable = TRUE,  caption = " Table 1: Summary statistics for global cumulative and new cases of COVID-19") %>% 
  kable_styling(full_width = F)  
 
```


```{r, child=if(input$country!='Select all') paste0(dir,'/','ChildReport.Rmd') ,eval=T}
```

The trends for confirmed, recovered and deaths cases for `r ifelse(input$country=='Select all',print('the World'),paste(input$country,ifelse(input$province!= 'Select all', paste(',',input$province) ,'')))` are presented in following figure. 

```{r  , echo=FALSE , fig.align="center", out.width = "30%", fig.cap = capFig("Trend of confirmed, recovered and deaths cases")}
    PlotCum <- reactive({
      if(input$country=="Select all" & input$province=="Select all"){
        aggregate(value~ variable+Date,WorldSum,FUN = "sum" )
      }else if (input$country!="Select all" & input$province=="Select all") {
        DF<-WorldSum[which(WorldSum$Country.Region==input$country), ] 
        aggregate(value~ variable+Date+Country.Region,DF,FUN = "sum" ) 
      }else{
        DF<-WorldSum[which(WorldSum$Country.Region==input$country & WorldSum$Province.State==input$province), ] 
        aggregate(value~ variable+Date+Province.State,DF,FUN = "sum" ) 
        
      }
    }) 
 PlotCum()%>%
 dplyr::group_by(variable)%>% 
          echarts4r::e_charts(Date) %>% 
          echarts4r::e_line(value) %>% 
          # echarts4r::e_line(model, name = "Fit", lineStyle = ls) %>% 
          echarts4r::e_tooltip(trigger = "axis")%>% 
          echarts4r::e_color(c("brown", "green","red") )%>% #,background = "gray"
          e_grid(containLabel=T,left = "20%",right = "20%")%>%   #show axes title completely
          e_theme("shine") # https://echarts4r.john-coene.com/articles/themes.html

```

## **COVID-19 death rate in `r ifelse(input$country=='Select all',print('the World'),paste(input$country,ifelse(input$province != 'Select all', paste(',',input$province) ,'')))`**

The death rate was determined based on [The Lancet article](https://www.thelancet.com/journals/laninf/article/PIIS1473-3099%2820%2930195-X/fulltext) by dividing the number of deaths on a given day by the number of patients with confirmed COVID-19 infection 14 days before.

```{r,echo=FALSE, fig.align="center", out.width = "30%", fig.cap = capFig("Change of death rate by date")}
        
        form <- htmlwidgets::JS("function(value){
    return(value + '%')
  }")
PlotCum() %>% 
            dplyr::group_by(variable) %>% 
            dplyr::ungroup() %>%
            tidyr::pivot_wider(
              id_cols = Date,
              names_from = variable,
              values_from = value
              
            ) %>%
            dplyr::mutate(
              #https://www.thelancet.com/journals/laninf/article/PIIS1473-3099(20)30195-X/fulltext
              #https://www.worldometers.info/coronavirus/coronavirus-death-rate/
              rate = Deaths / (lag(Confirmed,14)),
              rate = round(rate * 100, 3)
            ) %>%  
            mutate(rate=replace(rate, rate>100, 100)) %>%
            echarts4r::e_charts(Date) %>% 
            echarts4r::e_area(rate, name = "Death rate") %>% 
            echarts4r::e_tooltip(trigger = "axis") %>% 
            echarts4r::e_legend(FALSE) %>% 
            echarts4r::e_y_axis(formatter = form) %>% 
            #echarts4r::e_color(background = "gray" )%>%
            #echarts4r::e_visual_map(
            #   rate,
            #  show = FALSE,
            #  inRange = list(
            #    color = deaths_pal
            #  )
            # ) %>% 
            echarts4r::e_mark_point(
              data = list(type = "max"), 
              itemStyle = list(color = "skyblue"),
              label = list(color = "#000"),
              title = "Max"
            ) %>% 
            echarts4r::e_mark_line(
              data = list(type = "average"),
              itemStyle = list(color = "blue"),
              title = "Average"
            ) %>%
            e_grid(containLabel=T,right = "20%",left = "20%")%>%   #show axes title completely
            e_theme("shine") # https://echarts4r.john-coene.com/articles/themes.html
```

